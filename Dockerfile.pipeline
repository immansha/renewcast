FROM python:3.11-slim

WORKDIR /app

RUN apt-get update && apt-get install -y gcc g++ curl && rm -rf /var/lib/apt/lists/*

# Install urllib3 and requests first, alone, before anything else
RUN pip install --upgrade pip
RUN pip install urllib3==2.2.1 requests==2.31.0

# Now install everything else
RUN pip install numpy pandas python-dotenv pypdf openai faiss-cpu river pathway

# Force reinstall requests stack at the end so pathway can't overwrite it
RUN pip install --force-reinstall urllib3==2.2.1 requests==2.31.0

COPY pathway_pipeline/ ./pathway_pipeline/
COPY scripts/ ./scripts/

CMD ["python", "pathway_pipeline/main.py"]
