<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>RenewCast â€” Grid Intelligence</title>
<style>
:root{--bg:#060d1a;--s1:#0d1829;--s2:#111f33;--border:#1a2d4a;--accent:#00d4ff;--green:#00ff88;--yellow:#ffcc00;--red:#ff4444;--orange:#ff8800;--text:#cdd9e5;--muted:#4a6080}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono','Courier New',monospace;font-size:12px}
header{background:linear-gradient(135deg,#060d1a,#0a1628);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:12px}
h1{font-size:20px;color:var(--accent);letter-spacing:2px;text-shadow:0 0 20px rgba(0,212,255,0.5)}
.tag{background:rgba(0,212,255,0.1);color:var(--accent);border:1px solid rgba(0,212,255,0.3);padding:2px 10px;border-radius:3px;font-size:10px;letter-spacing:1px}
.live{display:flex;align-items:center;gap:8px;margin-left:auto}
.dot{width:8px;height:8px;border-radius:50%;background:var(--yellow);animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1;box-shadow:0 0 6px currentColor}50%{opacity:0.3}}
.live-txt{font-size:11px;letter-spacing:1px}

/* Plant status bar */
.plants-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border)}
.plant-card{background:var(--s1);padding:14px 18px}
.plant-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.plant-id{font-size:14px;font-weight:bold;letter-spacing:1px}
.plant-rj01{color:#60a5fa}.plant-gj01{color:#34d399}.plant-tn01{color:#f472b6}
.plant-state{font-size:10px;color:var(--muted)}
.meter{height:6px;background:var(--border);border-radius:3px;margin:6px 0;overflow:hidden}
.meter-fill{height:100%;border-radius:3px;transition:width 0.5s ease;background:linear-gradient(90deg,#00ff88,#00d4ff)}
.meter-fill.low{background:linear-gradient(90deg,#ff8800,#ff4444)}
.plant-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:8px}
.stat-box{background:var(--s2);padding:6px 8px;border-radius:4px;text-align:center}
.stat-val{font-size:13px;font-weight:bold;color:var(--yellow)}
.stat-lbl{font-size:9px;color:var(--muted);margin-top:2px;letter-spacing:0.5px}
.mae-bar{margin-top:8px;font-size:10px;color:var(--muted)}
.mae-improving{color:var(--green)}
.cloud-icon{font-size:11px}

/* Main grid */
.main{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);height:calc(100vh - 175px)}
.panel{background:var(--s1);display:flex;flex-direction:column;overflow:hidden}
.ph{padding:10px 16px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.ph-title{font-size:11px;letter-spacing:1.5px;color:var(--accent);text-transform:uppercase}
.ph-count{background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.2);color:var(--accent);padding:1px 8px;border-radius:99px;font-size:10px}
.pb{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:6px}
.pb::-webkit-scrollbar{width:3px}
.pb::-webkit-scrollbar-thumb{background:var(--border)}

/* Cards */
.dc{background:var(--s2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;border-left:3px solid var(--accent);transition:border-color 0.3s}
.dc.changed{border-left-color:var(--yellow);animation:flash 0.5s}
.dc.anomaly{border-left-color:var(--red)}
@keyframes flash{0%,100%{opacity:1}50%{opacity:0.6}}
.dc-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.badge{padding:2px 8px;border-radius:3px;font-size:10px;font-weight:bold;letter-spacing:0.5px}
.badge-rj01{background:rgba(96,165,250,0.15);color:#60a5fa;border:1px solid rgba(96,165,250,0.3)}
.badge-gj01{background:rgba(52,211,153,0.15);color:#34d399;border:1px solid rgba(52,211,153,0.3)}
.badge-tn01{background:rgba(244,114,182,0.15);color:#f472b6;border:1px solid rgba(244,114,182,0.3)}
.mw{color:var(--yellow);font-weight:bold;font-size:13px}
.cerc{font-size:10px;color:var(--muted);background:var(--border);padding:1px 6px;border-radius:3px}
.ts{font-size:10px;color:var(--muted)}
.dc-detail{font-size:10px;color:var(--muted);margin-top:4px;display:flex;gap:12px}

.ac{background:rgba(0,255,136,0.03);border:1px solid rgba(0,255,136,0.15);border-radius:6px;padding:12px;border-left:3px solid var(--green)}
.ac-meta{display:flex;gap:8px;margin-bottom:8px;align-items:center}
.ac-text{color:#a7f3d0;line-height:1.7;font-size:11px}

.anc{background:rgba(255,68,68,0.03);border:1px solid rgba(255,68,68,0.2);border-radius:6px;padding:12px;border-left:3px solid var(--red)}
.anc-meta{display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-wrap:wrap}
.anc-text{color:#fca5a5;line-height:1.7;font-size:11px}
.alert-badge{background:rgba(255,68,68,0.2);color:var(--red);border:1px solid rgba(255,68,68,0.4);padding:2px 8px;border-radius:3px;font-size:10px;font-weight:bold;animation:blink 1s infinite}

.es{color:var(--muted);text-align:center;padding:40px;font-size:11px;line-height:2}
</style>
</head>
<body>

<header>
  <h1>âš¡ RENEWCAST</h1>
  <span class="tag">PATHWAY PIPELINE</span>
  <span class="tag">ONLINE ML</span>
  <span class="tag">LIVE RAG</span>
  <span class="tag">LLM ADVISORY</span>
  <div class="live">
    <span class="live-txt" id="stxt" style="color:var(--yellow)">CONNECTING</span>
    <span class="dot" id="dot"></span>
  </div>
</header>

<!-- Plant Status Bar -->
<div class="plants-bar" id="plants-bar">
  <div class="plant-card"><div class="es">Loading RJ01...</div></div>
  <div class="plant-card"><div class="es">Loading GJ01...</div></div>
  <div class="plant-card"><div class="es">Loading TN01...</div></div>
</div>

<!-- Main Content -->
<div class="main">
  <div class="panel">
    <div class="ph"><span class="ph-title">âš¡ Dispatch Commands</span><span class="ph-count" id="dc-cnt">0</span></div>
    <div class="pb" id="dc-list"><div class="es">Waiting for pipeline...<br>Make sure docker compose up is running<br>and visit http://localhost:8000/status</div></div>
  </div>
  <div class="panel">
    <div class="ph"><span class="ph-title">ðŸ“‹ LLM Operator Advisories</span><span class="ph-count" id="adv-cnt">0</span></div>
    <div class="pb" id="adv-list"><div class="es">LLM advisories appear every ~1 minute<br>Grounded in live CERC regulations via RAG</div></div>
  </div>
  <div class="panel">
    <div class="ph"><span class="ph-title">ðŸš¨ Anomaly Reports</span><span class="ph-count" id="anom-cnt">0</span></div>
    <div class="pb" id="anom-list"><div class="es">âœ“ All plants nominal<br>Inject an event to trigger anomaly detection:<br>docker compose run --rm pathway_pipeline python scripts/inject_event.py --type=inverter_fault --plant=GJ01</div></div>
  </div>
  <div class="panel">
    <div class="ph"><span class="ph-title">ðŸ“¡ Live Telemetry Feed</span><span class="ph-count" id="tel-cnt">0</span></div>
    <div class="pb" id="tel-list"><div class="es">Telemetry streaming from 3 plants...</div></div>
  </div>
</div>

<script>
const API = 'http://localhost:8000';
const fmt = n => (n||0).toFixed(1);
const ts  = s => s ? new Date(s).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';

function badge(id){
  return `<span class="badge badge-${id.toLowerCase()}">${id}</span>`;
}

function cloudIcon(f){
  if(!f && f!==0) return '';
  if(f < 0.2) return 'â˜€ï¸';
  if(f < 0.5) return 'â›…';
  return 'â˜ï¸';
}

function renderPlants(dispatch, telemetry){
  const latestD={}, latestT={};
  dispatch.forEach(d=>{latestD[d.plant_id]=d});
  telemetry.forEach(t=>{latestT[t.plant_id]=t});

  return ['RJ01','GJ01','TN01'].map(id=>{
    const d=latestD[id], t=latestT[id];
    if(!d&&!t) return `<div class="plant-card"><div class="es">${id}: No data</div></div>`;

    const actual   = t?.ac_power_mw || 0;
    const capacity = t?.capacity_mw || 100;
    const p50      = d?.p50_mw || 0;
    const cloud    = t?.cloud_fraction || 0;
    const utilPct  = Math.min(100, (actual/capacity)*100);
    const isLow    = utilPct < 30;
    const cls      = `plant-${id.toLowerCase()}`;
    const simHour  = t?.simulated_hour ? `${t.simulated_hour.toFixed(1)}h` : '';

    return `<div class="plant-card">
      <div class="plant-header">
        <span class="plant-id ${cls}">${id}</span>
        <span class="plant-state">${t?.state||''} ${simHour}</span>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:22px;color:${isLow?'var(--orange)':'var(--green)'};font-weight:bold">${fmt(actual)} <span style="font-size:11px;color:var(--muted)">MW</span></span>
        <span class="cloud-icon">${cloudIcon(cloud)} ${(cloud*100).toFixed(0)}%</span>
      </div>
      <div class="meter"><div class="meter-fill ${isLow?'low':''}" style="width:${utilPct}%"></div></div>
      <div class="plant-stats">
        <div class="stat-box"><div class="stat-val" style="color:#93c5fd">${fmt(d?.p10_mw)}</div><div class="stat-lbl">P10</div></div>
        <div class="stat-box"><div class="stat-val">${fmt(p50)}</div><div class="stat-lbl">P50</div></div>
        <div class="stat-box"><div class="stat-val" style="color:#86efac">${fmt(d?.p90_mw)}</div><div class="stat-lbl">P90</div></div>
      </div>
      <div class="mae-bar">Backup: <strong style="color:var(--yellow)">${fmt(d?.allocated_mw)}MW</strong> ${d?.selected_asset||'â€”'} | CERC-${d?.cerc_merit_class||'?'}</div>
    </div>`;
  }).join('');
}

function renderDispatch(items){
  if(!items.length) return '<div class="es">Waiting for dispatch commands...</div>';
  return items.slice().reverse().slice(0,12).map(d=>`
    <div class="dc ${d.anomaly_detected?'anomaly':''}">
      <div class="dc-row">${badge(d.plant_id)}<span style="color:var(--accent);font-weight:bold">${fmt(d.allocated_mw)} MW</span><span class="ts">${ts(d.timestamp)}</span></div>
      <div class="dc-row"><span style="color:var(--text)">${d.selected_asset||'No backup needed'}</span><span class="cerc">CERC-${d.cerc_merit_class}</span></div>
      <div class="dc-detail">
        <span>P10: ${fmt(d.p10_mw)}</span>
        <span>P50: ${fmt(d.p50_mw)}</span>
        <span>P90: ${fmt(d.p90_mw)}</span>
        <span>gap: ${fmt(d.expected_gap_mw)}MW</span>
      </div>
      ${d.anomaly_detected?'<div style="color:var(--red);font-size:10px;margin-top:4px">âš  Anomaly flag â€” check anomaly panel</div>':''}
    </div>`).join('');
}

function renderAdvisories(items){
  if(!items.length) return '<div class="es">Advisories generated every ~1 minute<br>Each one is grounded in live CERC regulations via RAG</div>';
  return items.slice().reverse().slice(0,5).map(a=>`
    <div class="ac">
      <div class="ac-meta">${badge(a.plant_id)}<span class="ts">${ts(a.timestamp)}</span><span class="cerc">${a.dispatch_ref?.asset||'â€”'} ${fmt(a.dispatch_ref?.allocated_mw)}MW</span></div>
      <div class="ac-text">${a.advisory||'(generating...)'}</div>
    </div>`).join('');
}

function renderAnomalies(items){
  if(!items.length) return '<div class="es">âœ“ All plants nominal<br><br>To trigger: inject an inverter_fault event</div>';
  return items.slice().reverse().slice(0,5).map(a=>`
    <div class="anc">
      <div class="anc-meta">${badge(a.plant_id)}<span class="alert-badge">âš  ANOMALY</span><span class="ts">${ts(a.timestamp)}</span></div>
      <div class="anc-text">${a.report||'(generating...)'}</div>
    </div>`).join('');
}

function renderTelemetry(items){
  if(!items.length) return '<div class="es">Telemetry streaming...</div>';
  return items.slice().reverse().slice(0,15).map(t=>`
    <div class="dc" style="border-left-color:var(--muted)">
      <div class="dc-row">${badge(t.plant_id)}<span class="mw">${fmt(t.ac_power_mw)} MW</span><span class="ts">${ts(t.timestamp)}</span></div>
      <div class="dc-detail">
        <span>GHI: ${(t.ghi_wm2||0).toFixed(0)} W/mÂ²</span>
        <span>cloud: ${((t.cloud_fraction||0)*100).toFixed(0)}%</span>
        <span>inv: ${((t.inverter_efficiency||0)*100).toFixed(1)}%</span>
        <span>${t.injected_event!=='none'?'âš  '+t.injected_event:''}</span>
      </div>
    </div>`).join('');
}

async function refresh(){
  try{
    const[dispatch,advisories,anomalies,telemetry,status]=await Promise.all([
      fetch(`${API}/dispatch?n=50`).then(r=>r.json()),
      fetch(`${API}/advisories?n=10`).then(r=>r.json()),
      fetch(`${API}/anomalies?n=10`).then(r=>r.json()),
      fetch(`${API}/telemetry?n=50`).then(r=>r.json()),
      fetch(`${API}/status`).then(r=>r.json()),
    ]);

    document.getElementById('plants-bar').innerHTML = renderPlants(dispatch, telemetry);
    document.getElementById('dc-list').innerHTML    = renderDispatch(dispatch);
    document.getElementById('adv-list').innerHTML   = renderAdvisories(advisories);
    document.getElementById('anom-list').innerHTML  = renderAnomalies(anomalies);
    document.getElementById('tel-list').innerHTML   = renderTelemetry(telemetry);

    document.getElementById('dc-cnt').textContent   = status.records?.dispatch_commands||0;
    document.getElementById('adv-cnt').textContent  = status.records?.operator_advisories||0;
    document.getElementById('anom-cnt').textContent = status.records?.anomaly_reports||0;
    document.getElementById('tel-cnt').textContent  = status.records?.telemetry_rows||0;

    document.getElementById('stxt').textContent     = 'LIVE';
    document.getElementById('stxt').style.color     = 'var(--green)';
    document.getElementById('dot').style.background = 'var(--green)';
    document.getElementById('dot').style.color      = 'var(--green)';
  } catch(e){
    document.getElementById('stxt').textContent     = 'API OFFLINE';
    document.getElementById('stxt').style.color     = 'var(--red)';
    document.getElementById('dot').style.background = 'var(--red)';
  }
}

refresh();
setInterval(refresh, 2000);
</script>
</body>
</html>
